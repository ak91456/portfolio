# Multi-stage Dockerfile: node build (optional) -> python runtime
# Assumes Django with WSGI at core.wsgi:application.
# Adjust WSGI_MODULE if your entrypoint is different.

################################################################################
# Stage 1: optional frontend build (only runs if package.json exists)
################################################################################
FROM node:18-alpine AS node_builder
WORKDIR /frontend

# Copy package.json for caching. If no frontend, the COPY won't fail if package.json missing
# because we will guard build with --if-present.
COPY package*.json ./
RUN if [ -f package.json ]; then npm ci --silent; fi

# Copy rest and build if build script present
COPY . .
RUN if [ -f package.json ]; then npm run build --if-present; \
    mkdir -p /build && (if [ -d build ]; then cp -a build/. /build; elif [ -d dist ]; then cp -a dist/. /build; fi); \
    else mkdir -p /build; fi

################################################################################
# Stage 2: Python runtime
################################################################################
FROM python:3.11-slim
ENV PYTHONUNBUFFERED=1
WORKDIR /app

# Install minimal OS deps (add libpq-dev if you use Postgres)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential gcc curl libpq-dev \
  && rm -rf /var/lib/apt/lists/*

# Install Python deps (expects requirements.txt to be present)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Copy frontend build output (if any) from node_builder -> put under ./frontend_build
COPY --from=node_builder /build ./frontend_build

# Django static files root (adjust if different)
ENV STATIC_ROOT=/app/staticfiles
ENV PORT=10000
# Default WSGI_MODULE â€” change on Render or here if needed
ENV WSGI_MODULE=core.wsgi:application

# Collect static files (noinput so it won't prompt). If not a Django project,
# this command will likely error; keep it if you are using Django.
RUN if [ -f manage.py ]; then python manage.py collectstatic --noinput || true; fi

EXPOSE ${PORT}

# Use gunicorn to serve the WSGI app. Ensure gunicorn is in requirements.txt.
CMD ["sh", "-lc", "gunicorn --bind 0.0.0.0:${PORT:-10000} ${WSGI_MODULE} --workers 3 --timeout 120"]